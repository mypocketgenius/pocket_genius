generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Bookmark {
  id        String   @id
  messageId String
  userId    String
  chatbotId String
  chunkIds  String[] @default([])
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime
  Chatbot   Chatbot  @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  Message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([chatbotId])
  @@index([createdAt])
  @@index([userId])
}

model Category {
  id               String             @id
  type             CategoryType
  label            String
  slug             String
  icon             String?
  color            String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  Chatbot_Category Chatbot_Category[]

  @@unique([type, slug])
  @@index([type])
}

model Chatbot {
  id                                                        String                     @id
  title                                                     String
  creatorId                                                 String
  createdAt                                                 DateTime                   @default(now())
  allowAnonymous                                            Boolean                    @default(false)
  currency                                                  String                     @default("USD")
  description                                               String?
  isActive                                                  Boolean                    @default(true)
  isPublic                                                  Boolean                    @default(false)
  priceCents                                                Int                        @default(0)
  slug                                                      String?                    @unique
  type                                                      ChatbotType?
  imageUrl                                                  String?
  systemPrompt                                              String?
  modelProvider                                             String?
  modelName                                                 String?
  pineconeNs                                                String?
  vectorNamespace                                           String?
  configJson                                                Json?
  ragSettingsJson                                           Json?
  ingestionRunIds                                           String[]                   @default([])
  currentVersionId                                          String?                    @unique
  shortDescription                                          String?
  publicDashboard                                           Boolean                    @default(false)
  fallbackSuggestionPills                                   Json?
  welcomeMessage                                            String?
  Bookmark                                                  Bookmark[]
  Creator                                                   Creator                    @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  Chatbot_Version_Chatbot_currentVersionIdToChatbot_Version Chatbot_Version?           @relation("Chatbot_currentVersionIdToChatbot_Version", fields: [currentVersionId], references: [id])
  Chatbot_Category                                          Chatbot_Category[]
  Chatbot_Intake_Question                                   Chatbot_Intake_Question[]
  Chatbot_Ratings_Aggregate                                 Chatbot_Ratings_Aggregate?
  Chatbot_Source                                            Chatbot_Source[]
  Chatbot_Version_Chatbot_Version_chatbotIdToChatbot        Chatbot_Version[]          @relation("Chatbot_Version_chatbotIdToChatbot")
  Chunk_Performance                                         Chunk_Performance[]
  Conversation                                              Conversation[]
  Favorited_Chatbots                                        Favorited_Chatbots[]
  Intake_Response                                           Intake_Response[]
  Pill                                                      Pill[]
  Pill_Usage                                                Pill_Usage[]
  User_Context                                              User_Context[]

  @@index([isActive])
  @@index([isPublic])
  @@index([isPublic, isActive, type])
  @@index([publicDashboard])
  @@index([slug])
  @@index([type])
}

model Chatbot_Category {
  id             String   @id
  chatbotId      String
  categoryId     String
  relevanceScore Float?
  createdAt      DateTime @default(now())
  Category       Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  Chatbot        Chatbot  @relation(fields: [chatbotId], references: [id], onDelete: Cascade)

  @@unique([chatbotId, categoryId])
  @@index([categoryId])
  @@index([chatbotId])
}

model Chatbot_Intake_Question {
  id               String          @id
  chatbotId        String
  intakeQuestionId String
  displayOrder     Int
  isRequired       Boolean         @default(false)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime
  Chatbot          Chatbot         @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  Intake_Question  Intake_Question @relation(fields: [intakeQuestionId], references: [id], onDelete: Cascade)

  @@unique([intakeQuestionId, chatbotId])
  @@index([chatbotId])
  @@index([intakeQuestionId])
}

model Chatbot_Ratings_Aggregate {
  id                 String   @id
  chatbotId          String   @unique
  averageRating      Decimal  @db.Decimal(3, 2)
  ratingCount        Int      @default(0)
  ratingDistribution Json?
  updatedAt          DateTime
  Chatbot            Chatbot  @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
}

model Chatbot_Source {
  id        String   @id
  chatbotId String
  sourceId  String
  isActive  Boolean  @default(true)
  addedAt   DateTime @default(now())
  Chatbot   Chatbot  @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  Source    Source   @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@unique([chatbotId, sourceId])
  @@index([chatbotId])
  @@index([sourceId])
}

model Chatbot_Version {
  id                                                String         @id
  chatbotId                                         String
  versionNumber                                     Int
  title                                             String
  description                                       String?
  systemPrompt                                      String
  modelProvider                                     String
  modelName                                         String
  pineconeNs                                        String
  vectorNamespace                                   String
  configJson                                        Json?
  ragSettingsJson                                   Json?
  ingestionRunIds                                   String[]       @default([])
  allowAnonymous                                    Boolean        @default(false)
  priceCents                                        Int
  currency                                          String
  type                                              ChatbotType
  notes                                             String?
  changelog                                         String?
  createdByUserId                                   String
  activatedAt                                       DateTime?
  deactivatedAt                                     DateTime?
  createdAt                                         DateTime       @default(now())
  updatedAt                                         DateTime
  Chatbot_Chatbot_currentVersionIdToChatbot_Version Chatbot?       @relation("Chatbot_currentVersionIdToChatbot_Version")
  Chatbot_Chatbot_Version_chatbotIdToChatbot        Chatbot        @relation("Chatbot_Version_chatbotIdToChatbot", fields: [chatbotId], references: [id], onDelete: Cascade)
  User                                              User           @relation(fields: [createdByUserId], references: [id])
  Conversation                                      Conversation[]

  @@unique([chatbotId, versionNumber])
  @@index([activatedAt])
  @@index([chatbotId])
}

model Chunk_Performance {
  id                  String   @id
  chunkId             String
  sourceId            String
  chatbotId           String
  timesUsed           Int      @default(0)
  helpfulCount        Int      @default(0)
  notHelpfulCount     Int      @default(0)
  satisfactionRate    Float    @default(0)
  chunkText           String?
  chunkMetadata       Json?
  month               Int
  year                Int
  createdAt           DateTime @default(now())
  updatedAt           DateTime
  needsCaseStudyCount Int      @default(0)
  needsExamplesCount  Int      @default(0)
  needsScriptsCount   Int      @default(0)
  needsStepsCount     Int      @default(0)
  copyToUseNowCount   Int      @default(0)
  Chatbot             Chatbot  @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  Source              Source   @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  @@unique([chunkId, chatbotId, month, year])
  @@index([chatbotId, month, year, satisfactionRate])
  @@index([chatbotId, month, year, timesUsed])
  @@index([sourceId])
}

model Conversation {
  id                      String                 @id
  chatbotId               String
  userId                  String?
  status                  String                 @default("active")
  messageCount            Int                    @default(0)
  createdAt               DateTime               @default(now())
  updatedAt               DateTime
  chatbotVersionId        String
  intakeCompleted         Boolean                @default(false)
  intakeCompletedAt       DateTime?
  suggestionPillsCache    Json?
  suggestionPillsCachedAt DateTime?
  sourceIds               String[]               @default([])
  Chatbot                 Chatbot                @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  Chatbot_Version         Chatbot_Version        @relation(fields: [chatbotVersionId], references: [id], onDelete: Cascade)
  User                    User?                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  Conversation_Feedback   Conversation_Feedback?
  Message                 Message[]

  @@index([chatbotId, status])
  @@index([chatbotVersionId])
  @@index([userId])
}

model Conversation_Feedback {
  id             String       @id
  conversationId String       @unique
  userId         String?
  rating         Int?
  userGoal       String?
  goalAchieved   String?
  stillNeed      String?
  timeSaved      String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  Conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  User           User?        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([rating])
  @@index([userId])
}

model Creator {
  id           String         @id
  name         String
  createdAt    DateTime       @default(now())
  avatarUrl    String?
  bio          String?
  slug         String         @unique
  socialLinks  Json?
  shortBio     String?
  Chatbot      Chatbot[]
  Creator_User Creator_User[]
  File         File[]
  Source       Source[]
}

model Creator_User {
  id        String   @id
  creatorId String
  userId    String
  role      String   @default("OWNER")
  createdAt DateTime @default(now())
  updatedAt DateTime
  Creator   Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([creatorId, userId])
  @@index([creatorId])
  @@index([userId])
}

model Event {
  id        String   @id
  sessionId String?
  userId    String?
  eventType String
  chunkIds  String[] @default([])
  metadata  Json?
  timestamp DateTime @default(now())
  messageId String?
  Message   Message? @relation(fields: [messageId], references: [id], onDelete: Cascade)
  User      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([eventType])
  @@index([messageId])
  @@index([sessionId])
  @@index([timestamp])
  @@index([userId])
}

model Favorited_Chatbots {
  id        String   @id
  userId    String
  chatbotId String
  createdAt DateTime @default(now())
  Chatbot   Chatbot  @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, chatbotId])
  @@index([chatbotId])
  @@index([userId])
}

model File {
  id              String            @id
  sourceId        String
  creatorId       String
  fileName        String
  fileUrl         String
  fileSize        Int
  status          String            @default("PENDING")
  createdAt       DateTime          @default(now())
  Creator         Creator           @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  Source          Source            @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  Intake_Response Intake_Response[]

  @@index([creatorId])
  @@index([sourceId])
}

model Intake_Question {
  id                      String                    @id
  slug                    String                    @unique
  questionText            String
  helperText              String?
  responseType            IntakeResponseType
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  createdByUserId         String
  options                 Json?
  Chatbot_Intake_Question Chatbot_Intake_Question[]
  User                    User                      @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)
  Intake_Response         Intake_Response[]
}

model Intake_Response {
  id                       String          @id
  intakeQuestionId         String
  userId                   String
  chatbotId                String?
  fileId                   String?
  value                    Json
  reusableAcrossFrameworks Boolean         @default(false)
  createdAt                DateTime        @default(now())
  updatedAt                DateTime
  Chatbot                  Chatbot?        @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  File                     File?           @relation(fields: [fileId], references: [id], onDelete: Cascade)
  Intake_Question          Intake_Question @relation(fields: [intakeQuestionId], references: [id], onDelete: Cascade)
  User                     User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, intakeQuestionId, chatbotId])
  @@index([intakeQuestionId])
  @@index([userId])
}

model Message {
  id             String       @id
  conversationId String
  userId         String?
  role           String
  content        String
  context        Json?
  sourceIds      String[]     @default([])
  createdAt      DateTime     @default(now())
  followUpPills  String[]     @default([])
  Bookmark       Bookmark[]
  Event          Event[]
  Conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  User           User?        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([sourceIds])
  @@index([userId])
}

model Pill {
  id                                           String       @id
  chatbotId                                    String?
  pillType                                     String
  label                                        String
  prefillText                                  String
  displayOrder                                 Int          @default(0)
  isActive                                     Boolean      @default(true)
  createdAt                                    DateTime     @default(now())
  updatedAt                                    DateTime
  Chatbot                                      Chatbot?     @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  Pill_Usage_Pill_Usage_pairedWithPillIdToPill Pill_Usage[] @relation("Pill_Usage_pairedWithPillIdToPill")
  Pill_Usage_Pill_Usage_pillIdToPill           Pill_Usage[] @relation("Pill_Usage_pillIdToPill")

  @@index([chatbotId])
  @@index([pillType])
}

model Pill_Usage {
  id                                     String   @id
  pillId                                 String
  sessionId                              String?
  userId                                 String?
  chatbotId                              String
  sourceChunkIds                         String[] @default([])
  prefillText                            String
  sentText                               String
  wasModified                            Boolean  @default(false)
  pairedWithPillId                       String?
  timestamp                              DateTime @default(now())
  Chatbot                                Chatbot  @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  Pill_Pill_Usage_pairedWithPillIdToPill Pill?    @relation("Pill_Usage_pairedWithPillIdToPill", fields: [pairedWithPillId], references: [id])
  Pill_Pill_Usage_pillIdToPill           Pill     @relation("Pill_Usage_pillIdToPill", fields: [pillId], references: [id], onDelete: Cascade)
  User                                   User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([chatbotId])
  @@index([pillId])
  @@index([sessionId])
  @@index([userId])
}

model Source {
  id                String              @id
  title             String
  creatorId         String
  createdAt         DateTime            @default(now())
  authors           String?
  year              Int?
  license           String?
  licenseUrl        String?
  sourceUrl         String?
  Chatbot_Source    Chatbot_Source[]
  Chunk_Performance Chunk_Performance[]
  File              File[]
  Creator           Creator             @relation(fields: [creatorId], references: [id], onDelete: Cascade)
}

model User {
  id                    String                  @id
  clerkId               String                  @unique
  email                 String
  username              String?
  firstName             String?
  lastName              String?
  createdAt             DateTime                @default(now())
  Bookmark              Bookmark[]
  Chatbot_Version       Chatbot_Version[]
  Conversation          Conversation[]
  Conversation_Feedback Conversation_Feedback[]
  Creator_User          Creator_User[]
  Event                 Event[]
  Favorited_Chatbots    Favorited_Chatbots[]
  Intake_Question       Intake_Question[]
  Intake_Response       Intake_Response[]
  Message               Message[]
  Pill_Usage            Pill_Usage[]
  User_Context          User_Context[]
}

model User_Context {
  id         String        @id
  userId     String
  chatbotId  String?
  key        String
  value      Json
  source     ContextSource @default(USER_PROVIDED)
  confidence Float?
  expiresAt  DateTime?
  isVisible  Boolean       @default(true)
  isEditable Boolean       @default(true)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime
  Chatbot    Chatbot?      @relation(fields: [chatbotId], references: [id], onDelete: Cascade)
  User       User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, chatbotId, key])
  @@index([chatbotId])
  @@index([userId])
}

enum CategoryType {
  ROLE
  CHALLENGE
  STAGE
}

enum ChatbotType {
  BODY_OF_WORK
  FRAMEWORK
  DEEP_DIVE
  ADVISOR_BOARD
}

enum ContextSource {
  USER_PROVIDED
  INFERRED
  INTAKE_FORM
  PLATFORM_SYNC
}

enum IntakeResponseType {
  TEXT
  NUMBER
  SELECT
  MULTI_SELECT
  FILE
  DATE
  BOOLEAN
}
